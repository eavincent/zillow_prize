---
title: "Zillow Project Report"
author: "Liz Vincent"
date: "9/27/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(corrplot)
library(dplyr)
library(ggplot2)
library(magrittr)
library(stringi)
library(stringr)
library(rebus)

properties_2016<-read.csv("properties_2016.csv",stringsAsFactors = F)  # This takes a while...~3 million rows, 58 columns
train<-read.csv("train_2016_v2.csv")
```

## To-do:
* Handle categorical variables
* Going to need to handle missing data - either throw it out or impute
    + Create a colume for "imputed" in case of non-random missingness
* Use linear model as the baseline - whatever your machine learning algorithm is should do better than a linear model
* Predict by the mean as a baseline too - if the machine learning algorithm does worse than predicting by the mean, it's incorrect
* Plot missingness
* Make a table for RMSE and R^2 values to compare models 
* Upload code to Kaggle and make public so that code is reproducible for instructors

```{r variable_class}
factor_vars <- str_subset(names(properties_2016),pattern="id")
factor_vars <- c(factor_vars,"fips","propertycountylandusecode","propertyzoningdesc","rawcensustractandblock","censustractandblock")
properties_2016[,factor_vars]<-lapply(properties_2016[,factor_vars],factor)
str(properties_2016)
```

## Tidying

### Missingness

```{r data_import, include=FALSE}
# Count the number of NAs or empty strings in each column of properties_2016
missingness<-lapply(properties_2016,function(x){
    ifelse(is.character(x),
          sum(str_detect(x,pattern=START %R% END)),
          sum(is.na(x))
  )
})

# Format missingness
missingness<-round(unlist(missingness)/n*100,2)
missingness<-sort(missingness,decreasing=T)
missingness<-as.data.frame(missingness)
missingness$var<-stri_trans_totitle(row.names(missingness))
row.names(missingness)<-seq(1:nrow(missingness))
missingness<-select(missingness,c("var","missingness"))
```

```{r plot_missingness, echo=F}
missingness<-missingness %>% mutate(category = lapply(missingness,function(x){if(x < 5){"<5%"} else if(x>=5 & x <= 95){">=5%, <=95%"} else{">95%"}}))
missingness$category<-as.character(missingness$category)

ggplot(missingness,aes(x=reorder(var, missingness),y=missingness,fill=category)) +
  geom_col() +
  scale_fill_manual(breaks=c(">95%",">=5%, <=95%","<5%"),values=c("blue","black","red")) +
  scale_y_continuous(limits = c(NA,100),expand = c(0,0)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),legend.position = c(0.87,0.1),axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(element_blank())) +
  labs(y="Missingness (%)",x=element_blank()) +
  coord_flip()
```

### Imputation

Although at first glance it appears that many values have very high missingness, there are several instances in which "missing" data may actually be a negative response. For example, `taxdelinquencyflag` is missing for `r missingness[missingness$var == "Taxdelinquencyflag","missingness"]` of observations, when in reality these are probably observations in which there has not been a tax delinquency flag. Therefore, I will not exclude tax delinquency tag or year based on missingness, but will impute the missing values for tax delinquency tag as negative responses.

```{r imputation}
imputed_properties_2016<-properties_2016

imputed_properties_2016$taxdelinquencyflag <- ifelse(imputed_properties_2016$taxdelinquencyflag == "Y",TRUE,FALSE)
imputed_properties_2016[!is.na(imputed_properties_2016$taxdelinquencyyear) & imputed_properties_2016$taxdelinquencyyear == 0,"taxdelinquencyyear"] <- NA

imputed_properties_2016[!is.na(imputed_properties_2016$fireplacecnt),"fireplaceflag"]<-TRUE
imputed_properties_2016[imputed_properties_2016$fireplaceflag == "true","fireplaceflag"] <- TRUE
imputed_properties_2016$fireplaceflag <- as.logical(imputed_properties_2016$fireplaceflag)

imputed_properties_2016[!is.na(imputed_properties_2016$basementsqft),"basement"] <- TRUE
imputed_properties_2016<-imputed_properties_2016[,!(names(imputed_properties_2016) == "storytypeid")] # Only storytypeid is "basement" and completely overlaps with basementsqft values - created new value called "basement" that is logical and removing storytypeid

imputed_properties_2016[!is.na(imputed_properties_2016$poolcnt) | !is.na(imputed_properties_2016$poolsizesum) | !is.na(imputed_properties_2016$pooltypeid10) | !is.na(imputed_properties_2016$pooltypeid2) | !is.na(imputed_properties_2016$pooltypeid7),"pool"] <- TRUE
imputed_properties_2016$pooltypeid10<-as.logical(ifelse(imputed_properties_2016$pooltypeid10 == 1, TRUE, NA))
imputed_properties_2016$pooltypeid7<-as.logical(ifelse(imputed_properties_2016$pooltypeid7 == 1, TRUE, NA))
imputed_properties_2016$pooltypeid2<-as.logical(ifelse(imputed_properties_2016$pooltypeid2 == 1, TRUE, NA))

imputed_properties_2016[!is.na(imputed_properties_2016$pooltypeid10) | !is.na(imputed_properties_2016$pooltypeid7),"pooltypeid2"] <- FALSE
imputed_properties_2016[!is.na(imputed_properties_2016$pooltypeid10) | !is.na(imputed_properties_2016$pooltypeid2),"pooltypeid7"] <- FALSE
imputed_properties_2016[!is.na(imputed_properties_2016$pooltypeid7) | !is.na(imputed_properties_2016$pooltypeid2),"pooltypeid10"] <- FALSE

imputed_properties_2016<-imputed_properties_2016[,!(names(imputed_properties_2016) %in% c("poolcnt","hashottuborspa"))] # These are redundant with "pool" and "poolytpeid2/10", which both include information about hottub or spa

missingness<-lapply(imputed_properties_2016,function(x){
    ifelse(is.character(x),
          sum(str_detect(x,pattern=START %R% END)),
          sum(is.na(x))
  )
})

# Format missingness
missingness<-round(unlist(missingness)/n*100,2)
missingness<-sort(missingness,decreasing=T)
missingness<-as.data.frame(missingness)
missingness$var<-stri_trans_totitle(row.names(missingness))
row.names(missingness)<-seq(1:nrow(missingness))
missingness<-select(missingness,c("var","missingness"))

missingness<-missingness %>% mutate(category = lapply(missingness,function(x){if(x < 5){"<5%"} else if(x>=5 & x <= 95){">=5%, <=95%"} else{">95%"}}))
missingness$category<-as.character(missingness$category)

ggplot(missingness,aes(x=reorder(var, missingness),y=missingness,fill=category)) +
  geom_col() +
  scale_fill_manual(breaks=c(">95%",">=5%, <=95%","<5%"),values=c("blue","black","red")) +
  scale_y_continuous(limits = c(NA,100),expand = c(0,0)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),legend.position = c(0.87,0.1),axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(element_blank())) +
  labs(y="Missingness (%)",x=element_blank()) +
  coord_flip()

```

```{r pressure, echo=FALSE}
# calculate correlations of variables
M <- cor(imputed_properties_2016,use="pairwise.complete.obs")
```
