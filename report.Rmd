---
title: "Zillow Project Report"
author: "Liz Vincent"
date: "9/27/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(corrplot)
library(dplyr)
library(ggplot2)
library(magrittr)
library(stringi)
library(stringr)
library(rebus)
library(gridExtra)

properties<-read.csv("properties_2016.csv",stringsAsFactors = F)  # This takes a while...~3 million rows, 58 columns
train<-read.csv("train_2016_v2.csv")
```

## To-do:
* Tidy training data
    + Handle categorical variables
    + Handle missing data - either throw it out or impute
    + Create a column for "imputed" in case of non-random missingness
* Subset training data into train and test
* Use linear modelas the baseline - whatever your machine learning algorithm is should do better than a linear model
    + Compare to predict by the mean (i.e. predict the mean for every observation) - if the machine learning algorithm does worse than predicting by the mean, it's incorrect
* Upload code to Kaggle and make public so that code is reproducible for instructors

Tables and figures:
* Plot missingness
* Make a table for RMSE and R^2 values to compare models 


# Training Data

## Tidying

Tidy the training data first.

```{r train_variable_class}
train<-merge(train,properties,by="parcelid")
factor_vars <- str_subset(names(train),pattern="id")
factor_vars <- c(factor_vars,"fips","propertycountylandusecode","propertyzoningdesc","rawcensustractandblock","censustractandblock")
train[,factor_vars]<-lapply(train[,factor_vars],factor)
str(train)
```

### Missingness

```{r train_missingness, include=FALSE}
# Count the number of NAs or empty strings in each column of properties_2016
missingness<-lapply(train,function(x){
    ifelse(is.character(x),
          sum(str_detect(x,pattern=START %R% END)),
          sum(is.na(x))
  )
})

# Format missingness
missingness<-round(unlist(missingness)/nrow(train)*100,2)
missingness<-sort(missingness,decreasing=T)
missingness<-as.data.frame(missingness)
missingness$var<-stri_trans_totitle(row.names(missingness))
row.names(missingness)<-seq(1:nrow(missingness))
missingness<-select(missingness,c("var","missingness"))
missingness<-missingness %>% mutate(category = lapply(missingness,function(x){if(x < 5){"<5%"} else if(x>=5 & x <= 95){">=5%, <=95%"} else{">95%"}}))
missingness$category<-as.character(missingness$category)
```

```{r train_plot_missingness, echo=F}
p1 <- ggplot(missingness,aes(x=reorder(var, missingness),y=missingness,fill=category)) +
  geom_col() +
  scale_fill_manual(breaks=c(">95%",">=5%, <=95%","<5%"),values=c("blue","black","red")) +
  scale_y_continuous(limits = c(NA,100),expand = c(0,0)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),legend.position = c(0.87,0.1),axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(element_blank())) +
  labs(y="Missingness (%)",x=element_blank()) +
  coord_flip()

p1
```

### Imputation

```{r train_imputation}
imputed_train<-train

imputed_train$taxdelinquencyflag <- ifelse(imputed_train$taxdelinquencyflag == "Y",TRUE,FALSE)
imputed_train[!is.na(imputed_train$taxdelinquencyyear) & imputed_train$taxdelinquencyyear == 0,"taxdelinquencyyear"] <- NA

imputed_train[!is.na(imputed_train$fireplacecnt),"fireplaceflag"]<-TRUE
imputed_train[imputed_train$fireplaceflag == "true","fireplaceflag"] <- TRUE
imputed_train$fireplaceflag <- as.logical(imputed_train$fireplaceflag)

imputed_train[!is.na(imputed_train$basementsqft),"basement"] <- TRUE
imputed_train<-imputed_train[,!(names(imputed_train) == "storytypeid")] # Only storytypeid is "basement" and completely overlaps with basementsqft values - created new value called "basement" that is logical and removing storytypeid

imputed_train[!is.na(imputed_train$poolcnt) | !is.na(imputed_train$poolsizesum) | !is.na(imputed_train$pooltypeid10) | !is.na(imputed_train$pooltypeid2) | !is.na(imputed_train$pooltypeid7),"pool"] <- TRUE
imputed_train$pooltypeid10<-as.logical(ifelse(imputed_train$pooltypeid10 == 1, TRUE, NA))
imputed_train$pooltypeid7<-as.logical(ifelse(imputed_train$pooltypeid7 == 1, TRUE, NA))
imputed_train$pooltypeid2<-as.logical(ifelse(imputed_train$pooltypeid2 == 1, TRUE, NA))

imputed_train[!is.na(imputed_train$pooltypeid10) | !is.na(imputed_train$pooltypeid7),"pooltypeid2"] <- FALSE
imputed_train[!is.na(imputed_train$pooltypeid10) | !is.na(imputed_train$pooltypeid2),"pooltypeid7"] <- FALSE
imputed_train[!is.na(imputed_train$pooltypeid7) | !is.na(imputed_train$pooltypeid2),"pooltypeid10"] <- FALSE

imputed_train<-imputed_train[,!(names(imputed_train) %in% c("poolcnt","hashottuborspa"))] # These are redundant with "pool" and "poolytpeid2/10", which both include information about hottub or spa
```


```{r test_recalculate_missingness,}
missingness<-lapply(imputed_train,function(x){
    ifelse(is.character(x),
          sum(str_detect(x,pattern=START %R% END)),
          sum(is.na(x))
  )
})

# Format missingness
missingness<-round(unlist(missingness)/nrow(train)*100,2)
missingness<-sort(missingness,decreasing=T)
missingness<-as.data.frame(missingness)
missingness$var<-stri_trans_totitle(row.names(missingness))
row.names(missingness)<-seq(1:nrow(missingness))
missingness<-select(missingness,c("var","missingness"))

missingness<-missingness %>% mutate(category = lapply(missingness,function(x){if(x < 5){"<5%"} else if(x>=5 & x <= 95){">=5%, <=95%"} else{">95%"}}))
missingness$category<-as.character(missingness$category)
```

```{r echo=F}
p2 <- ggplot(missingness,aes(x=reorder(var, missingness),y=missingness,fill=category)) +
  geom_col() +
  scale_fill_manual(breaks=c(">95%",">=5%, <=95%","<5%"),values=c("blue","black","red")) +
  scale_y_continuous(limits = c(NA,100),expand = c(0,0)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),legend.position = c(0.87,0.1),axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(element_blank())) +
  labs(y="Missingness (%)",x=element_blank()) +
  coord_flip()

p2

ggplot(train, aes(x=latitude,y=longitude,color=regionidcity)) +
   geom_point() +
   theme(legend.position = "none")

ggplot(train, aes(x=latitude,y=longitude,color=taxamount)) +
   geom_point() +
   theme(legend.position = "none") +
  scale_color_gradient2()

#ggplot(train[is.na(train$taxamount),], aes(x=latitude,y=longitude,color=taxamount)) +
#  geom_point() +
#  ylim(c(min(train$longitude),max(train$longitude))) +
#  xlim(c(min(train$latitude),max(train$latitude))) +
#  theme(legend.position = "none") +
#  scale_color_gradient2()

sqrt(a^2 +b^2)
# Calculate physical dstances between properties
# take a sample of the 5 nearest homes, houses with NA for regionidcity will be classified as the regioncityid of the majority of its 5 nearest neighbors


```

```{r}
ggplot(train, aes(x=latitude,y=longitude,color=ifelse(is.na(regionidcity),"NA",""))) +
  geom_point()

ggplot(train, aes(x=latitude,y=longitude,color=regionidcity)) +
  geom_point() +
  theme(legend.position = "none")
```

### Correlation

```{r pressure, echo=FALSE}
# calculate correlations of variables
M <- cor(imputed_train,use="pairwise.complete.obs")
```

# New Data

## Tidying
Tidy the data for which logerrors are to be predicted.

```{r test_variable_classes}

```

### Missingness
```{r test_missingness, include=FALSE}
# Count the number of NAs or empty strings in each column of properties_2016
missingness<-lapply(properties,function(x){
    ifelse(is.character(x),
          sum(str_detect(x,pattern=START %R% END)),
          sum(is.na(x))
  )
})

# Format missingness
missingness<-round(unlist(missingness)/nrow(train)*100,2)
missingness<-sort(missingness,decreasing=T)
missingness<-as.data.frame(missingness)
missingness$var<-stri_trans_totitle(row.names(missingness))
row.names(missingness)<-seq(1:nrow(missingness))
missingness<-select(missingness,c("var","missingness"))
missingness<-missingness %>% mutate(category = lapply(missingness,function(x){if(x < 5){"<5%"} else if(x>=5 & x <= 95){">=5%, <=95%"} else{">95%"}}))
missingness$category<-as.character(missingness$category)
```

```{r plot_missingness, echo=F}
ggplot(missingness,aes(x=reorder(var, missingness),y=missingness,fill=category)) +
  geom_col() +
  scale_fill_manual(breaks=c(">95%",">=5%, <=95%","<5%"),values=c("blue","black","red")) +
  scale_y_continuous(limits = c(NA,100),expand = c(0,0)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),legend.position = c(0.87,0.1),axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(element_blank())) +
  labs(y="Missingness (%)",x=element_blank()) +
  coord_flip()
```

### Imputation

Although at first glance it appears that many values have very high missingness, there are several instances in which "missing" data may actually be a negative response. For example, `taxdelinquencyflag` is missing for `r missingness[missingness$var == "Taxdelinquencyflag","missingness"]` of observations, when in reality these are probably observations in which there has not been a tax delinquency flag. Therefore, I will not exclude tax delinquency tag or year based on missingness, but will impute the missing values for tax delinquency tag as negative responses.

```{r imputation}
imputed_properties<-properties

imputed_properties$taxdelinquencyflag <- ifelse(imputed_properties$taxdelinquencyflag == "Y",TRUE,FALSE)
imputed_properties[!is.na(imputed_properties$taxdelinquencyyear) & imputed_properties$taxdelinquencyyear == 0,"taxdelinquencyyear"] <- NA

imputed_properties[!is.na(imputed_properties$fireplacecnt),"fireplaceflag"]<-TRUE
imputed_properties[imputed_properties$fireplaceflag == "true","fireplaceflag"] <- TRUE
imputed_properties$fireplaceflag <- as.logical(imputed_properties$fireplaceflag)

imputed_properties[!is.na(imputed_properties$basementsqft),"basement"] <- TRUE
imputed_properties<-imputed_properties[,!(names(imputed_properties) == "storytypeid")] # Only storytypeid is "basement" and completely overlaps with basementsqft values - created new value called "basement" that is logical and removing storytypeid

imputed_properties[!is.na(imputed_properties$poolcnt) | !is.na(imputed_properties$poolsizesum) | !is.na(imputed_properties$pooltypeid10) | !is.na(imputed_properties$pooltypeid2) | !is.na(imputed_properties$pooltypeid7),"pool"] <- TRUE
imputed_properties$pooltypeid10<-as.logical(ifelse(imputed_properties$pooltypeid10 == 1, TRUE, NA))
imputed_properties$pooltypeid7<-as.logical(ifelse(imputed_properties$pooltypeid7 == 1, TRUE, NA))
imputed_properties$pooltypeid2<-as.logical(ifelse(imputed_properties$pooltypeid2 == 1, TRUE, NA))

imputed_properties[!is.na(imputed_properties$pooltypeid10) | !is.na(imputed_properties$pooltypeid7),"pooltypeid2"] <- FALSE
imputed_properties[!is.na(imputed_properties$pooltypeid10) | !is.na(imputed_properties$pooltypeid2),"pooltypeid7"] <- FALSE
imputed_properties[!is.na(imputed_properties$pooltypeid7) | !is.na(imputed_properties$pooltypeid2),"pooltypeid10"] <- FALSE

imputed_properties<-imputed_properties[,!(names(imputed_properties) %in% c("poolcnt","hashottuborspa"))] # These are redundant with "pool" and "poolytpeid2/10", which both include information about hottub or spa

missingness<-lapply(imputed_properties,function(x){
    ifelse(is.character(x),
          sum(str_detect(x,pattern=START %R% END)),
          sum(is.na(x))
  )
})

# Format missingness
missingness<-round(unlist(missingness)/n*100,2)
missingness<-sort(missingness,decreasing=T)
missingness<-as.data.frame(missingness)
missingness$var<-stri_trans_totitle(row.names(missingness))
row.names(missingness)<-seq(1:nrow(missingness))
missingness<-select(missingness,c("var","missingness"))

missingness<-missingness %>% mutate(category = lapply(missingness,function(x){if(x < 5){"<5%"} else if(x>=5 & x <= 95){">=5%, <=95%"} else{">95%"}}))
missingness$category<-as.character(missingness$category)

ggplot(missingness,aes(x=reorder(var, missingness),y=missingness,fill=category)) +
  geom_col() +
  scale_fill_manual(breaks=c(">95%",">=5%, <=95%","<5%"),values=c("blue","black","red")) +
  scale_y_continuous(limits = c(NA,100),expand = c(0,0)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),legend.position = c(0.87,0.1),axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(element_blank())) +
  labs(y="Missingness (%)",x=element_blank()) +
  coord_flip()

```